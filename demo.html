<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>demo</title>
    <link rel="stylesheet" href="css/weui.min.css" />
    <link rel="stylesheet" href="css/jquery-weui.min.css">
</head>

<body>
    <div class="page__bd">
        <div class="weui-gallery" id="gallery">
            <span class="weui-gallery__img" id="galleryImg"></span>
            <div class="weui-gallery__opr">
                <a href="javascript:" class="weui-gallery__del">
                    <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                </a>
            </div>
        </div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">图片上传</p>
                            <div class="weui-uploader__info" id="img_info">0/9</div>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderFiles">

                            </ul>
                            <div class="weui-uploader__input-box" id="img_url_btn_box">
                                <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"
                                    multiple="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-weui.min.js"></script>
    <script src="./js/layer/layer.js"></script>
    <script>
        $(function () {
            let img_files = [];
            let maxCount = 9;
            let img_num = 0;
            let flieTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
            let maxSize = 3 * 1024 * 1024;
            let tmpl = '<li class="weui-uploader__file" id="#ImgID#" style="background-image:url(#url#)"></li>',
                $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
                $uploaderInput = $("#uploaderInput"),
                $uploaderFiles = $("#uploaderFiles")
                ;
            $uploaderInput.on("change", function (e) {
                var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
                for (let i = 0, len = files.length; i < len; i++) {
                    img_files[img_num] = files[i];
                    let file = files[i];
                    let imgID = genGUID();
                    img_num++;
                    if (flieTypes.indexOf(file.type) === -1) {
                        layer.msg("该类型不允许上传");
                        return;
                    }
                    if (file.size > maxSize) {
                        layer.msg("图片太大");
                        return;
                    }
                    if (img_num > maxCount) {
                        img_num = maxCount;
                        $('#img_url_btn_box').css('display', 'none');
                        layer.msg("最多只能选择"+maxCount+'张图片');
                        break;
                    }
                    if (url) {
                        src = url.createObjectURL(file);

                    } else {
                        src = e.target.result;
                    }
                    $uploaderFiles.append($(tmpl.replace('#url#', src).replace('#ImgID#', imgID)));

                }
                if (img_num >= maxCount) {

                    $('#img_url_btn_box').css('display', 'none');
                }

                $('#img_info').text(img_num + '/' + maxCount);

                uploaderInput.value = "";
            });

            //查看图片
            let index;
            $uploaderFiles.on("click", "li", function () {
                index = $(this).index();
                $galleryImg.attr("style", this.getAttribute("style"));
                $gallery.fadeIn(100);
            });
            $gallery.on("click", function () {
                $gallery.fadeOut(100);
            });

            // 删除图片
            $(".weui-gallery__del").click(function () {

                $uploaderFiles.find("li").eq(index).remove();
                img_files.splice(index, 1);
                img_num--;
                $('#img_info').text(img_num + '/' + maxCount);
                if (img_num < maxCount) {
                    $('#img_url_btn_box').css('display', '');
                }
                uploaderInput.value = "";
            });
        })

        //生成guid
        function genGUID() {
            var G1 = (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1) + (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            var G2 = (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1) + (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            return (G1 + G2);
        }
    </script>
</body>

</html>
